name: Release

on:
  push:
    branches: [mine]
  workflow_dispatch:

permissions:
  contents: write

env:
  RELEASE_VERSION: "1.5.9"

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.v.outputs.version }}
    steps:
      - id: v
        run: echo "version=${RELEASE_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.v.outputs.version }}
          name: "Release ${{ steps.v.outputs.version }}"
          body: "Automated build for ${{ steps.v.outputs.version }}"
          draft: false
          prerelease: false

  build-and-upload:
    name: Build and Upload
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        node: [lts/*]
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: true

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node }}
          cache: npm

      - name: Set app version
        shell: bash
        run: |
          TARGET="${{ needs.create-release.outputs.version }}"
          CURRENT="$(node -p "require('./package.json').version")"
          echo "current=$CURRENT target=$TARGET"
          if [ "$CURRENT" = "$TARGET" ]; then
            echo "Version already $TARGET, skip npm version."
            exit 0
          fi
          npm version "$TARGET" --no-git-tag-version

      - name: Build
        env:
          os: ${{ runner.os == 'Windows' && 'win' || runner.os == 'macOS' && 'macos' || 'linux' }}
        run: |
          npm run install-all
          npm run build
          npm run electron:build:${{ env.os }}

      - name: List dist_electron
        run: |
          if [ -d dist_electron ]; then
            ls -la dist_electron
          else
            dir dist_electron
          fi
        shell: bash

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.create-release.outputs.version }}
          files: |
            dist_electron/*.exe
            dist_electron/*.exe.blockmap
            dist_electron/latest.yml

            dist_electron/*.dmg

            dist_electron/*.AppImage
            dist_electron/*.deb